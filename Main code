# tableau_inventory_pat_no_users_WITH_SAFE_STATS.py
# -------------------------------------------------
# PAT auth, no /users call, safe handling of usage stats (no direct v.total_views access).

import os
import pandas as pd
import tableauserverclient as TSC

# ========= CONFIG (EDIT THESE) =========
SERVER      = "https://mytableau.cvs.com"   # root URL (no '/#/')
SITE_ID     = "RX_OPS"                      # e.g., RX_OPS
PAT_NAME    = "YOUR_PAT_NAME"
PAT_SECRET  = "YOUR_PAT_SECRET"

OUTPUT_CSV        = "tableau_inventory.csv"
DOWNLOAD_VIEW_CSV = False                   # True = export underlying data CSVs (needs permission)
VIEW_CSV_DIR      = "view_csvs"
# ======================================

def link_for_view(server_base, site_id, content_url):
    return f"{server_base}/#/site/{site_id}/views/{content_url}"

def link_for_workbook(server_base, site_id, content_url):
    return f"{server_base}/#/site/{site_id}/workbooks/{content_url}"

def main():
    server = TSC.Server(SERVER, use_server_version=True)
    auth   = TSC.PersonalAccessTokenAuth(PAT_NAME, PAT_SECRET, SITE_ID)

    rows = []

    with server.auth.sign_in(auth):
        # Projects you can see
        projects, _ = server.projects.get()
        projects_by_id = {p.id: p for p in projects}

        # Datasources (best-effort)
        try:
            datasources, _ = server.datasources.get()
            ds_by_id = {d.id: d for d in datasources}
        except Exception:
            ds_by_id = {}

        # --------- PRELOAD USAGE STATS FOR VIEWS (SAFE) ---------
        view_usage_by_id = {}
        try:
            vreq = TSC.RequestOptions()
            vreq.include_usage_statistics = True
            while True:
                vpage, vpagination = server.views.get(req_options=vreq)
                for vv in vpage:
                    # ONLY touch vv.total_views here (it's populated by this request)
                    view_usage_by_id[vv.id] = getattr(vv, "total_views", None)
                if vpagination.current_page_number < vpagination.total_page_count:
                    vreq.page_number = vpagination.current_page_number + 1
                else:
                    break
        except Exception:
            # If not allowed to fetch usage stats, just leave dict empty; we'll default to None
            view_usage_by_id = {}
        # --------------------------------------------------------

        # Workbooks (paged)
        wb_req = TSC.RequestOptions()
        while True:
            workbooks, page = server.workbooks.get(req_options=wb_req)

            for wb in workbooks:
                # Views & connections in this workbook
                try:
                    server.workbooks.populate_views(wb)
                except Exception:
                    wb.views = []

                try:
                    server.workbooks.populate_connections(wb)
                except Exception:
                    wb.connections = []

                proj   = projects_by_id.get(wb.project_id)
                wb_url = link_for_workbook(SERVER, SITE_ID, wb.content_url)

                # Datasource hints for this workbook
                ds_names, ds_types = [], []
                for c in getattr(wb, "connections", []):
                    ds_obj = ds_by_id.get(getattr(c, "datasource_id", None))
                    if ds_obj:
                        ds_names.append(ds_obj.name or "")
                        ds_types.append(ds_obj.connection_type or "")
                    else:
                        ds_names.append(getattr(c, "server_address", "") or "embedded/unknown")
                        ds_types.append(getattr(c, "connection_type", "") or "unknown")

                for v in getattr(wb, "views", []):
                    v_url = link_for_view(SERVER, SITE_ID, v.content_url)

                    # ✅ Do NOT access v.total_views here. Look it up from our preloaded dict.
                    total_views = view_usage_by_id.get(v.id, None)

                    saved_csv_path = None
                    if DOWNLOAD_VIEW_CSV:
                        try:
                            os.makedirs(VIEW_CSV_DIR, exist_ok=True)
                            csv_bytes = server.views.populate_csv(v)  # needs "Download Full Data"
                            safe = f"{(proj.name if proj else 'NoProject')}__{wb.name}__{v.name}".replace("/", "_").replace("\\", "_")
                            saved_csv_path = os.path.join(VIEW_CSV_DIR, f"{safe}.csv")
                            with open(saved_csv_path, "wb") as f:
                                f.write(csv_bytes)
                        except Exception as e:
                            saved_csv_path = f"ERROR: {e}"

                    rows.append({
                        "project_name":      proj.name if proj else None,
                        "project_id":        wb.project_id,
                        "workbook_name":     wb.name,
                        "workbook_id":       wb.id,
                        "workbook_url":      wb_url,
                        "workbook_created":  getattr(wb, "created_at", None),
                        "workbook_updated":  getattr(wb, "updated_at", None),
                        "owner_id":          getattr(wb, "owner_id", None),   # UUID; no /users lookup
                        "view_name":         v.name,
                        "view_id":           v.id,
                        "view_url":          v_url,
                        "view_total_views":  total_views,                     # from preloaded dict
                        "datasource_names":  "; ".join(sorted(set(n for n in ds_names if n))),
                        "datasource_types":  "; ".join(sorted(set(t for t in ds_types if t))),
                        "saved_view_csv":    saved_csv_path
                    })

            if page.current_page_number < page.total_page_count:
                wb_req.page_number = page.current_page_number + 1
            else:
                break

    pd.DataFrame(rows).sort_values(
        ["project_name", "workbook_name", "view_name"], na_position="last"
    ).to_csv(OUTPUT_CSV, index=False)
    print(f"✅ Wrote {len(rows):,} rows to {OUTPUT_CSV}")
    if DOWNLOAD_VIEW_CSV:
        print(f"📁 Per-view CSVs (if exported) saved under: {VIEW_CSV_DIR}")

if __name__ == "__main__":
    main()
